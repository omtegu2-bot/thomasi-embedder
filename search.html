<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Search with Tokenized Boost</title>
<style>
body { font-family: sans-serif; margin: 20px; }
input { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 10px; }
.entry { padding: 10px; border-bottom: 1px solid #ddd; position: relative; cursor: pointer; }
.entry:hover { background-color: #f0f0f0; }
.score { font-size: 0.9em; color: #555; margin-left: 5px; }
.hamburger {
    position: absolute; right: 10px; top: 10px;
    cursor: pointer; font-size: 1.2em; user-select: none;
    border: none; background: none; padding: 5px;
}
.hamburger:focus { outline: 2px solid #333; }
.breakdown { display: none; padding: 5px 10px; background: #eef; margin-top: 5px; border-radius: 4px; }
.highlight { background-color: yellow; }
#popup {
  position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
  background: #333; color: #fff; padding: 10px 20px; border-radius: 5px;
  opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
#result-count {
  margin-bottom: 10px;
  font-weight: bold;
}
</style>
</head>
<body>

<input type="text" id="search" placeholder="Search...">
<div id="result-count"></div>
<div id="results">Loading data...</div>
<div id="popup">Copied to clipboard!</div>

<script>
let data = [];

// Load JSON
fetch('scraped_async.json')
  .then(response => response.json())
  .then(json => {
      data = json;
      document.getElementById('results').innerHTML = '';
      renderResults('');
  })
  .catch(err => {
      document.getElementById('results').innerHTML = 'Failed to load JSON.';
      console.error(err);
  });

// Debounce function
function debounce(fn, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
    };
}

// Compute score using tokenization + boosts
function computeScore(entry, query) {
    query = query.toLowerCase().trim();
    if (!query) return { score: 0, breakdown: {} };

    const tokens = query.split(/\s+/);
    let score = 0;
    let breakdown = {};

    const fields = [
        { key: 'title', points: 10 },
        { key: 'url', points: 9 },
        { key: 'description', points: 8 },
        { key: 'tag1', points: 6 },
        { key: 'tag2', points: 6 },
        { key: 'tag3', points: 6 },
        { key: 'tag4', points: 6 },
        { key: 'tag5', points: 7 },
        { key: 'common_word', points: 5 }
    ];

    fields.forEach(field => {
        let text = entry[field.key];
        if (!text) return;
        text = String(text).toLowerCase();
        let matches = 0;
        tokens.forEach(token => {
            if (text.includes(token)) matches++;
            // Extra boost for exact token match
            if (text === token) matches += 2;
        });
        if (matches > 0) {
            let fieldScore = field.points * matches;
            // Boost longer queries slightly
            fieldScore += Math.floor(query.length / 10);
            breakdown[field.key] = fieldScore;
            score += fieldScore;
        }
    });

    return { score, breakdown };
}

// Highlight matched tokens
function highlightMatch(text, query) {
    if (!query) return text;
    const tokens = query.split(/\s+/);
    tokens.forEach(token => {
        const regex = new RegExp(`(${token})`, 'gi');
        text = text.replace(regex, '<span class="highlight">$1</span>');
    });
    return text;
}

// Render search results
function renderResults(query) {
    const resultsDiv = document.getElementById("results");
    const countDiv = document.getElementById("result-count");
    resultsDiv.innerHTML = "";

    if (!data.length) {
        countDiv.innerText = "No data loaded.";
        return;
    }

    const filtered = data
        .map(entry => ({ entry, result: computeScore(entry, query) }))
        .filter(e => e.result.score > 0)
        .sort((a, b) => b.result.score - a.result.score);

    countDiv.innerText = filtered.length > 0
        ? `Showing ${filtered.length} of ${data.length} entries`
        : `No results found out of ${data.length} entries`;

    filtered.forEach(item => {
        if (!item.entry.tag1) item.entry.tag1 = "none";
        if (!item.entry.tag2) item.entry.tag2 = "none";

        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
            <strong>${highlightMatch(item.entry.title, query)}</strong>
            <span class="score">(Point Value: ${item.result.score})</span>
            <button class="hamburger" tabindex="0">â˜°</button>
            <br>${highlightMatch(item.entry.url, query)}<br>
            ${highlightMatch(item.entry.description, query)}
            <div class="breakdown">
                <strong>Score Breakdown:</strong>
                <ul>
                    ${Object.entries(item.result.breakdown).map(([k,v]) => `<li>${k}: +${v}</li>`).join('')}
                </ul>
            </div>
        `;

        const hamburger = div.querySelector(".hamburger");
        const breakdownDiv = div.querySelector(".breakdown");

        hamburger.addEventListener("click", () => {
            breakdownDiv.style.display = breakdownDiv.style.display === "block" ? "none" : "block";
        });

        div.addEventListener("click", (e) => {
            if (e.target === hamburger) return;
            navigator.clipboard.writeText(item.entry.url).then(() => {
                const popup = document.getElementById("popup");
                popup.style.opacity = 1;
                setTimeout(() => popup.style.opacity = 0, 1500);
            });
        });

        resultsDiv.appendChild(div);
    });
}

// Attach debounced search listener
document.getElementById("search").addEventListener("input", debounce((e) => {
    renderResults(e.target.value);
}, 200));
</script>

</body>
</html>
