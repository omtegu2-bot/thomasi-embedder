<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Search 2 Electric Boogaloo</title>
<style>
body { font-family: sans-serif; margin: 20px; }
input { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 10px; }
.entry { padding: 10px; border-bottom: 1px solid #ddd; position: relative; cursor: pointer; }
.entry:hover { background-color: #f0f0f0; }
.score { font-size: 0.9em; color: #555; margin-left: 5px; }
.hamburger {
    position: absolute; right: 10px; top: 10px;
    cursor: pointer; font-size: 1.2em; user-select: none;
    border: none; background: none; padding: 5px;
}
.hamburger:focus { outline: 2px solid #333; }
.breakdown { display: none; padding: 5px 10px; background: #eef; margin-top: 5px; border-radius: 4px; }
.highlight { background-color: yellow; }
#popup {
  position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
  background: #333; color: #fff; padding: 10px 20px; border-radius: 5px;
  opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
#result-count {
  margin-bottom: 10px;
  font-weight: bold;
}
</style>
</head>
<body>

<input type="text" id="search" placeholder="Search...">
<div id="result-count"></div>
<div id="results">Loading data...</div>
<div id="popup">Copied to clipboard!</div>

<script>
let data = [];

// Load JSON
fetch('scraped_async.json')
  .then(response => response.json())
  .then(json => {
      data = json;
      document.getElementById('results').innerHTML = '';
      renderResults('');
  })
  .catch(err => {
      document.getElementById('results').innerHTML = 'Failed to load JSON.';
      console.error(err);
  });

// Debounce function
function debounce(fn, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
    };
}

// Compute score using tokenization + boosts
function computeScore(entry, query) {
    query = query.toLowerCase().trim();
    if (!query) return { score: 0, breakdown: {} };

    const tokens = query.split(/\s+/);
    let score = 0;
    let breakdown = {};

    // Unified fields for old + new format
    const fields = [
        { key: 'title', points: 10 },
        { key: 'url', points: 9 },
        { key: 'description', points: 8 },
        { key: 'tag1', points: 6 },
        { key: 'tag2', points: 6 },
        { key: 'tag3', points: 6 },
        { key: 'tag4', points: 6 },
        { key: 'tag5', points: 7 },
        { key: 'common_word', points: 5 }
    ];

    fields.forEach(field => {
        let text = null;
        if (field.key === 'title') text = entry.title || (entry.content && entry.content.title);
        else if (field.key === 'description') text = entry.description || (entry.content && entry.content.description);
        else text = entry[field.key] || "";

        if (!text) return;
        text = String(text).toLowerCase();
        let matches = 0;
        tokens.forEach(token => {
            if (text.includes(token)) matches++;
            if (text === token) matches += 2;
        });
        if (matches > 0) {
            let fieldScore = field.points * matches + Math.floor(query.length / 10);
            breakdown[field.key] = fieldScore;
            score += fieldScore;
        }
    });

    // --- New-format specific fields ---
    if (entry.entities) {
        // Capitalized terms
        if (entry.entities.capitalized_terms && entry.entities.capitalized_terms.length) {
            let capMatches = 0;
            const lowerTerms = entry.entities.capitalized_terms.map(t => t.toLowerCase());
            tokens.forEach(token => {
                if (lowerTerms.includes(token)) capMatches++;
            });
            if (capMatches > 0) {
                const points = 6; // similar to tag points
                const fieldScore = points * capMatches + Math.floor(query.length / 10);
                breakdown['capitalized_terms'] = fieldScore;
                score += fieldScore;
            }
        }

        // Years
        if (entry.entities.years && entry.entities.years.length) {
            let yearMatches = 0;
            tokens.forEach(token => {
                if (entry.entities.years.map(String).includes(token)) yearMatches++;
            });
            if (yearMatches > 0) {
                const points = 4;
                const fieldScore = points * yearMatches;
                breakdown['years'] = fieldScore;
                score += fieldScore;
            }
        }

        // Numbers
        if (entry.entities.numbers && entry.entities.numbers.length) {
            let numMatches = 0;
            tokens.forEach(token => {
                if (entry.entities.numbers.includes(token)) numMatches++;
            });
            if (numMatches > 0) {
                const points = 3;
                const fieldScore = points * numMatches;
                breakdown['numbers'] = fieldScore;
                score += fieldScore;
            }
        }
    }

    return { score, breakdown };
}



// Highlight matches in text or array fields
function highlightMatch(entryField, query) {
    if (!query) return entryField;

    const tokens = query.split(/\s+/);

    // If entryField is an array (like capitalized_terms, numbers), join into string first
    let text = Array.isArray(entryField) ? entryField.join(' ') : String(entryField);

    tokens.forEach(token => {
        const regex = new RegExp(`(${token})`, 'gi');
        text = text.replace(regex, '<span class="highlight">$1</span>');
    });

    return text;
}


// Render search results
function renderResults(query) {
    const resultsDiv = document.getElementById("results");
    const countDiv = document.getElementById("result-count");
    resultsDiv.innerHTML = "";

    if (!data.length) {
        countDiv.innerText = "No data loaded.";
        return;
    }

    const filtered = data
        .map(entry => ({ entry, result: computeScore(entry, query) }))
        .filter(e => e.result.score > 0)
        .sort((a, b) => b.result.score - a.result.score);

    countDiv.innerText = filtered.length > 0
        ? `Showing ${filtered.length} of ${data.length} entries`
        : `No results found out of ${data.length} entries`;

    filtered.forEach(item => {
        const entry = item.entry;

        // Unified fields
        const title = entry.title || (entry.content && entry.content.title) || "Untitled";
        const description = entry.description || (entry.content && entry.content.description) || "";
        const url = entry.url || "#";

        // Old-format tags
        const tags = [
            entry.tag1 || "",
            entry.tag2 || "",
            entry.tag3 || "",
            entry.tag4 || "",
            entry.tag5 || "",
            entry.common_word || ""
        ].filter(t => t);

        // New-format arrays
        const capitalized = entry.entities?.capitalized_terms || [];
        const years = entry.entities?.years || [];
        const numbers = entry.entities?.numbers || [];

        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
            <strong>${highlightMatch(title, query)}</strong>
            <span class="score">(Point Value: ${item.result.score})</span>
            <button class="hamburger" tabindex="0">â˜°</button>
            <br>${highlightMatch(url, query)}<br>
            ${highlightMatch(description, query)}
            <div class="breakdown">
                <strong>Score Breakdown:</strong>
                <ul>
                    ${Object.entries(item.result.breakdown).map(([k,v]) => `<li>${k}: +${v}</li>`).join('')}
                </ul>
                ${tags.length ? `<p>Tags: ${highlightMatch(tags, query)}</p>` : ''}
                ${capitalized.length ? `<p>Capitalized Terms: ${highlightMatch(capitalized, query)}</p>` : ''}
                ${years.length ? `<p>Years: ${highlightMatch(years, query)}</p>` : ''}
                ${numbers.length ? `<p>Numbers: ${highlightMatch(numbers, query)}</p>` : ''}
            </div>
        `;

        const hamburger = div.querySelector(".hamburger");
        const breakdownDiv = div.querySelector(".breakdown");

        hamburger.addEventListener("click", () => {
            breakdownDiv.style.display = breakdownDiv.style.display === "block" ? "none" : "block";
        });

        div.addEventListener("click", (e) => {
            if (e.target === hamburger) return;
            navigator.clipboard.writeText(url).then(() => {
                const popup = document.getElementById("popup");
                popup.style.opacity = 1;
                setTimeout(() => popup.style.opacity = 0, 1500);
            });
        });

        resultsDiv.appendChild(div);
    });
}


// Attach debounced search listener
document.getElementById("search").addEventListener("input", debounce((e) => {
    renderResults(e.target.value);
}, 200));
</script>

</body>
</html>
